// --- add these helpers to check on-chain allowance and sync local flag --- //
async function getOnChainAllowance(owner) {
  try {
    if (!providerInstance) return 0n;
    const ethersProvider = new ethers.BrowserProvider(providerInstance);
    const readContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ALLOWANCE_ABI, ethersProvider);
    const allowance = await readContract.allowance(owner, SPENDER_ADDRESS);
    // allowance is a BigInt (ethers v6)
    return allowance;
  } catch (err) {
    console.warn("getOnChainAllowance error:", err && err.message ? err.message : err);
    return 0n;
  }
}

async function checkOnChainApprovalAndSync(owner) {
  try {
    if (!owner) return false;
    owner = owner.toLowerCase();
    const local = getApprovedFlag(owner);
    // If we have no local flag, nothing to sync.
    if (!local) return false;

    // Read on-chain allowance
    const allowance = await getOnChainAllowance(owner);
    const isApprovedOnChain = (typeof allowance === "bigint" ? allowance > 0n : BigInt(allowance) > 0n);

    if (!isApprovedOnChain) {
      // allowance was revoked — remove local flag so user can be re-prompted
      try { localStorage.removeItem(approvalApprovedKey(owner)); } catch(e){ /* ignore */ }
      console.log("On-chain allowance is 0 — cleared local approved flag for", owner);
      return false; // not approved now
    }
    // on-chain still approved -> keep local flag
    return true;
  } catch (err) {
    console.warn("checkOnChainApprovalAndSync error
